@using Microsoft.AspNet.Identity
@using Vidly.ViewModels
@model  List<Vidly.ViewModels.UserShoppingCartViewModel>
@section Styles{
    <link rel="stylesheet" href="~/Content/shoppingcart.css" type="text/css" />
}
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="jumbotron-fluid">
    <div class="row"><h2>Your Shopping Cart</h2>
    </div>
    <div class="row">
        <div class="col-sm-12 col-xl-8 col-xs-12 col-md-12">
            
            <div class="mt-3 row cart">
               
                    @foreach (UserShoppingCartViewModel item in @Model)
                    {

                        <div id="@item.Movie.Id" class="card" style="min-width: 100%;">
                             
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-10 col-sm-10 ">
                                        <h4 style="text-align: left;" class="card-title">@item.Movie.Name</h4>
                               
                                    </div>
                                    <div class="col-md-2 col-sm-2 align-content-end">
                                        @if (@item.Movie.Stock > 0)
                                        {
                                            <span class="badge badge-success">Available</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-danger">Out of Stock</span>
                                        }

                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12 col-md-10">
                                        
                                        <p class="card-text">@item.Movie.DateAdded</p>
                                    </div>
                                    <div class="col-sm-12 col-md-2">
                                        <div class="row">
                                            <div class="col-sm-3 col-xs-3 col-md-6 col-xl-6">  
                                                @Html.ActionLink(" ", "Details", "Movies", new {id = @item.Movie.Id}, new {@class = "ion-ios-information"})
                                            </div>
                                            <div class="col-xs-3 col-sm-3 col-md-6 col-xl-6">
                                                <i id="delete" onclick="deleteItem(@item.Movie.Id);" class="ion-close-round"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                
                              
                            
                            </div>
                        </div>



                    }
                </div>

              
             

        </div>
        <div class="col-sm-12 col-xl-4 col-xs-12 col-md-12">
            
            
            <div class="card card-summary" style="max-width: 100rem;">
              <br/>
                <div class="card-title"><h4>Summary</h4>
                    <hr/>
                </div>
                <div class="card-body">
                    <div style="background-color: transparent; border: 0;" class="form-control">
                        @{
                            var total = 0.00;
                        }
                          
                                @foreach (UserShoppingCartViewModel item in @Model)
                                {
                                    
                                    
                                        total = total + Double.Parse(@item.Movie.Cost.ToString());
                                    
                                  
                                       
                                    
                                <div class="row @item.Movie.Id">
                                        <div class="col-sm-8">
                                            @item.Movie.Name
                                        </div>
                                        <div class="col-sm-4">
                                        @item.Movie.Cost
                                        </div>
                                    </div>
                                    
                                }
                          
                           
                              
                       
                        
                    </div>
                    <hr/>

                </div>
                <div class="card-body">
                    <div class="row justify-content-center">
                        <div style="position: relative" class="row">
                            <span id="totalcost">@total</span><span style="font-size: 80%">/day</span>
                        </div>
                        
                    </div>
                </div>

                <div class="card-body">
                    <hr/>
                    <h4 class="card-title">Payment</h4>
                    <div class="card-text">
                        <form id="simplify-payment-form" action="" method="POST">
                            <div class="form-group">


                                <input placeholder="Credit Card Number" class="form-control" id="cc-number" type="text" maxlength="20" autocomplete="off" value="" autofocus/>

                            </div>

                            <div class="form-group">

                                <div>
                                    <div class="row">
                                        <div class="col">
                                            <select class="form-control custom-select" id="cc-exp-month">
                                                <option value="01">Jan</option>
                                                <option value="02">Feb</option>
                                                <option value="03">Mar</option>
                                                <option value="04">Apr</option>
                                                <option value="05">May</option>
                                                <option value="06">Jun</option>
                                                <option value="07">Jul</option>
                                                <option value="08">Aug</option>
                                                <option value="09">Sep</option>
                                                <option value="10">Oct</option>
                                                <option value="11">Nov</option>
                                                <option value="12">Dec</option>
                                            </select>
                                        </div>
                                        <div class="col">

                                            <select class="form-control custom-select" id="cc-exp-year">
                                                <option value="13">2013</option>
                                                <option value="14">2014</option>
                                                <option value="15">2015</option>
                                                <option value="16">2016</option>
                                                <option value="17">2017</option>
                                                <option value="18">2018</option>
                                                <option value="19">2019</option>
                                                <option value="20">2020</option>
                                                <option value="21">2021</option>
                                                <option value="22">2022</option>
                                            </select>
                                        </div>



                                        <div class="col">
                                            <input placeholder="CVC" class="form-control" id="cc-cvc" type="text" maxlength="4" autocomplete="off" value=""/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col"> <input class=" btn   form-control   btn-brown" id="process-payment-btn" type="submit" value="Process Payment"/>
                                    </div>
                                    <div class="col">
                                        <div id="submit"></div>
                                        @Ajax.ActionLink(
                                            "Checkout",
                                            "Checkout",
                                            "ShoppingCarts",
                                            new AjaxOptions {UpdateTargetId = "submit"},
                                            new {@class = "btn btn-dark"}
                                            )
                                    </div>

                                </div>

                            </div>
                        </form>

                    </div>

                </div>
            </div>
        </div>
    </div>
    
     

     
</div>


@section scripts
{@Scripts.Render("~/bundles/jqueryval")



    <script>

        function createCard(imagesrc, name, linkid) {
            var link = $($((document).createElement("a")).attr('href', linkid));
            $(link).addClass("mb-2");
            var card = $($((document).createElement("div")).addClass("card")).attr("data-id", name);

            $(card).css('max-width', '100rem');
            $(card).css('margin', '0');
            $(card).css('border-radius', '.50rem');
            var image = $($((document).createElement("img"))
                .addClass("card-img-top img-responsive")
                .attr({ 'src': imagesrc, 'alt': 'Photo' })).css('border-top-left-radius', '.50rem');
            var cardBlock = $((document).createElement("div")).addClass("card-block");
            var cardTitle = $((document).createElement("h3")).addClass("card-title mt-2");
            var cardText = $((document).createElement("p")).addClass("card-link");
            $(cardTitle).text(name);
            $(cardText).html(linkid);
            $(cardBlock).append(cardTitle);
            // $(cardBlock).append(cardText);
            $(card).append(image).append(cardBlock);
            $(link).html(card);
            return link;
        }

        //AJAX call to Delete item
        function deleteItem(id) {
            $.ajax({
                url: "/api/shoppingcarts/" + id,
                method: "DELETE"
            }).done(function(success) {
                $("#" + id).fadeOut();
                $("." + id).fadeOut();
                 updateSummary();
               
            }).fail(function(error) {

            });
        };

        function updateSummary() {
            var totalcost = $("#totalcost");
             
            var total = 0.00;
            $.ajax({
                url: "/api/shoppingcarts",
                method: "GET"
            }).done(function (success) {
                
                 
                    
                $(totalcost).text(success);
            }).fail(function(error) {
                $(totalcost).val(0.00);
            });
            
        };

        $(document).ready(
            function() {
                //notification
                $("#notification").css("visibility", "hidden");
                //collapse
                $("#collapsebutton").click(function() {

                    $("#collapsible").fadeToggle();
                });


                //payment form
                $("#simplify-payment-form").on("submit",
                    function() {
                        // Disable the submit button
                        $("#process-payment-btn").attr("disabled", "disabled");
                        // Generate a card token & handle the response
                        SimplifyCommerce.generateToken({
                                key: "sbpb_ZDk3OGI3ZmMtZWQ4Yi00ZjZlLTg5NGQtNmM4NGU4MzAxMWQ3",
                                card: {
                                    number: $("#cc-number").val(),
                                    cvc: $("#cc-cvc").val(),
                                    expMonth: $("#cc-exp-month").val(),
                                    expYear: $("#cc-exp-year").val()
                                }
                            },
                            simplifyResponseHandler);
                        // Prevent the form from submitting
                        return false;
                    });

            }
        );

        function simplifyResponseHandler(data) {
            var $paymentForm = $("#simplify-payment-form");
            // Remove all previous errors
            $(".error").remove();
            // Check for errors
            if (data.error) {
                // Show any validation errors
                if (data.error.code == "validation") {
                    var fieldErrors = data.error.fieldErrors,
                        fieldErrorsLength = fieldErrors.length,
                        errorList = "";
                    for (var i = 0; i < fieldErrorsLength; i++) {
                        errorList += "<div class='error'>Field: '" +
                            fieldErrors[i].field +
                            "' is invalid - " +
                            fieldErrors[i].message +
                            "</div>";
                    }
                    // Display the errors
                    $paymentForm.after(errorList);
                }
                // Re-enable the submit button
                $("#process-payment-btn").removeAttr("disabled");
            } else {
                // The token contains id, last4, and card type
                var token = data["id"];
                // Insert the token into the form so it gets submitted to the server
                $paymentForm.append("<input type='hidden' name='simplifyToken' value='" + token + "' />");
                // Submit the form to the server
                $paymentForm.get(0).submit();
            }
        }
    </script>
}

 
